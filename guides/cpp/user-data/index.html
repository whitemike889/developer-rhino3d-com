<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>User Data with C/C++</title>
  <meta name="description" content="This guide covers user data using C/C++.  Using C/C++">

  <!-- OpenGraph for Facebook, Twitter, Slack unfurling -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/guides/cpp/user-data/" />
  <meta property="og:title" content="User Data" />
  <meta property="og:description" content="This guide covers user data using C/C++." />
  <meta property=”og:site_name” content="developer.rhino3d.com"/>
  <meta property=”og:image” content="http://developer.rhino3d.com/images/rhinodev-logo-unfurl.png"/>

  <!-- twitter card tags additive with the og: tags -->
  <meta name="twitter:domain" value="developer.rhino3d.com" />
  <meta name="twitter:title" value="User Data" />
  <meta name="twitter:description" value="This guide covers user data using C/C++." />
  
    <meta name="twitter:image" content="http://developer.rhino3d.com/images/rhinodev-logo-unfurl.png" />
  
  <meta name="twitter:url" value="http://developer.rhino3d.com" />
  
  <meta name="twitter:label1" value="Platform(s)" />
  <meta name="twitter:data1" value="Windows" />
  
  
  <meta name="twitter:label2" value="Language(s)" />
  <meta name="twitter:data2" value="C/C++" />
  

  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/vbnet.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="/node_modules/highlightjs-line-numbers.js/dist/highlightjs-line-numbers.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script>hljs.initLineNumbersOnLoad();</script>

  <!-- Overridden theme -->
  <link rel="stylesheet" href="/css/main.css">

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  <!-- Optional theme -->
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous"> -->
  <!-- Bootstrap override -->
  <link rel="stylesheet" href="/css/bootstrap-override.css">

  <link rel="canonical" href="http://developer.rhino3d.com/guides/cpp/user-data/">
  <link rel="alternate" type="application/rss+xml" title="Rhino Developer Docs" href="http://developer.rhino3d.com/feed.xml" />

  <link rel="shortcut icon" href="http://developer.rhino3d.com/favicon.ico?v=2" />
  <!-- Saving bookmarks to mobile devices -->
  <!-- For non-Retina (@1× display) iPhone, iPod Touch, and Android 2.1+ devices: -->
  <link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png"><!-- 57×57px -->
  <!-- For the iPad mini and the first- and second-generation iPad (@1× display) on iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
  <!-- For the iPad mini and the first- and second-generation iPad (@1× display) on iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/images/apple-touch-icon-76x76-precomposed.png">
  <!-- For iPhone with @2× display running iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
  <!-- For iPhone with @2× display running iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/apple-touch-icon-120x120-precomposed.png">
  <!-- For iPad with @2× display running iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">
  <!-- For iPad with @2× display running iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/images/apple-touch-icon-152x152-precomposed.png">
  <!-- For iPhone 6 Plus with @3× display: -->
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/images/apple-touch-icon-180x180-precomposed.png">
  <!-- For Chrome for Android: -->
  <link rel="icon" sizes="192x192" href="images/touch-icon-192x192.png">

  <!-- Diable crawling until this version is the stable version -->
  <!--<meta name="robots" content="noindex" />-->
</head>


  <body>

    <!-- Google Tag Manager **This belongs right after the <body> tag**-->
    <noscript>
        <iframe src="//www.googletagmanager.com/ns.html?id=GTM-MWMDKN"
        height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <script>
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MWMDKN');
    </script>
    <!-- End Google Tag Manager -->


    

<!-- The following are "casts" from the string to number using math filters... -->



<!-- ...but we need to check to see if the original branches were numbers or not... -->









  <div class="version-banner">

    
      
        
        
          <strong>NEW:</strong> Welcome to the <strong>Rhino 6</strong> version of this page! <a href="/5/guides/cpp/user-data/">Looking for the older Rhino 5 version?</a>
        
        
      
    
</div>

<!-- Check the version banner for broken links and remove the link if found -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>
$(document).ready(function()
{
  var splitPath = window.location.pathname.split("/");
  var linkURL = "/5/" + splitPath.splice(1,splitPath.length-1).join("/");

  $.get(linkURL).fail(function ()
  {
    var $aTag = $("div.version-banner > a");
    $aTag.text("Looking for the older Rhino 5 site?");
    $aTag.attr("href", "/5/");
  });
});
</script>


    <div class="container">

      <header class="site-header">


    <a class="site-title" href="/"><img src="/images/rhinodevlogo148x128.png" alt="Rhino Developer Docs" height="48" width="56"></a><a class="site-title" href="/">Rhino Developer Docs</a>

    <nav class="site-nav">
      <img class="menu-icon" src="/images/gi.svg">
      
      <div class="trigger">
      	<!--<a class="page-link" href="/">Welcome</a>-->
        <!-- get current page title and "collection" to figure out which nav
             link should be "active" -->
        
        
        
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
        
          
            
              
                
                  <a class="page-link active" href="/guides/">Guides</a>
                
              
            
          
        
          
            
              
                
                  <a class="page-link" href="/api/">API</a>
                
              
            
          
        
          
            
              
                
                  <a class="page-link" href="/samples/">Samples</a>
                
              
            
          
        
          
            
          
        
          
            
              
                
                  <a class="page-link" href="/videos/">Videos</a>
                
              
            
          
        
        <a class="page-link" href="http://discourse.mcneel.com/c/rhino-developer">Forums</a>
        <!-- Google Search Engine -->
        <!-- TODO Move to this site back into the Mcneel search, or use a simple site only search for results -->
        <div id="sitesearch">
            <!-- CSE Search Box Begins  -->
            <form id="search-box" name="search-box" onsubmit="sitesearchFunction()" action="/search-results.html">
                <input id="searchtext" type="search" name="q" size="24" value="" placeholder="Search" />
                <input class="searchBox" type="submit" size="2" value=" " />
            </form>
			<script type="text/javascript">
			function sitesearchFunction(){
				var form_id = document.getElementById("search-box");
				var form_action = form_id.action;
                var form_sb = document.getElementById("searchtext");
				var query_src = form_sb.value + " site:developer.rhino3d.com";
				form_sb.value = query_src.toString();
			}
			</script>        
<!-- Google CSE Search Box Ends -->
        </div>
        <!--End of Google Search Engine -->
      </div>
    </nav>

</header>


      <div class="page-content">
        <!--div class="wrapper"-->
          <div class="container-fluid">

<div class="row-fluid">
    <!--Nav Bar -->
    <nav class="col-xs-0 col-md-3 bs-docs-sidebar">
    <ul id="sidebar" class="nav nav-stacked fixed">
        <!-- Find the h2 group and any h3 subgroups -->
        

        
          

          
            
            
            
            
            <li>
              <a href="#overview">Overview</a>

              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#document-user-data">Document User Data</a>

              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#object-user-data">Object User Data</a>

              
                <ul class="nav nav-stacked">
                  

                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#attaching-object-user-data-to-crhinoobjects">Attaching Object User Dat...</a>
                    </li>
                  

                </ul>
              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#samples">Samples</a>

              
                <ul class="nav nav-stacked">
                  

                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#cmyuserdata1">CMyUserData1</a>
                    </li>
                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#cmyuserdata2">CMyUserData2</a>
                    </li>
                  

                </ul>
              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#user-data-operator-and-copy-construction">User Data operator= and C...</a>

              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#sharing-user-data-between-plugins">Sharing User Data Between...</a>

              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#related-topics">Related Topics</a>

              

            </li>
          

        
    </ul>
</nav>


    <!--Main Content -->
    <div class="col-xs-12 col-md-9">
      <!--<div class="post">-->

        <article class="post-content">

          <ol class="breadcrumb">
              
              
              
              <li><a href="/guides/cpp">C/C++</a></li>

              
                
                  <li class="active">Fundamentals</li>
                
              
          </ol>

          <h1>User Data</h1>

          <p>
  <span class="guide_byline">
    
      
      
        by <a href="https://discourse.mcneel.com/users/dale/activity">Dale Fugier</a>
      
    
  </span>

</p>

          <p>This guide covers user data using C/C++.</p>

          <h2 id="overview">Overview</h2>

<p>There are two basic ways plugins can store information in Rhino <em>.3dm</em> files:</p>

<ol>
  <li><em>Document User Data</em></li>
  <li><em>Object User Data</em></li>
</ol>

<p>For example, a rendering plugin might save a scene description as <em>Document User Data</em> and use <em>Object User Data</em> to attach rendering material information to individual surfaces.</p>

<h2 id="document-user-data">Document User Data</h2>

<p>To save document user data your plugin must override three <code>CRhinoPlugIn</code> base class functions:</p>

<pre><code class="language-cpp">CRhinoPlugIn::CallWriteDocument
CRhinoPlugIn::WriteDocument
CRhinoPlugIn::ReadDocument
</code></pre>

<p>When Rhino writes a <em>.3dm</em> file, it goes through all the plugins that are currently loaded.  First Rhino calls <code>CallWriteDocument()</code> to see if the plugin wants to save document user data.  If <code>CallWriteDocument()</code> returns <code>true</code>, Rhino saves information that identifies the plugin and then calls <code>WriteDocument()</code> when it is time for the plugin to save its document user data.</p>

<p>When Rhino reads a <em>.3dm</em> file and it encounters document user data, it uses the plugin identification information to load the plugin and then calls the plugin’s <code>ReadDocument()</code> to read the plugin’s document user data.</p>

<h2 id="object-user-data">Object User Data</h2>

<p>Object user data can be attached to things like layers, materials, geometry objects, and object attributes.  In fact object user data can be attached to any class derived from <code>ON_Object</code>.  This user data is stored in a linked list on <code>ON_Object</code> and can be copied, transformed, and saved along with the parent object.  For example, you could attach object user data to a mesh.  When the mesh is copied the object user data is copied and attached to the copy.  When the mesh is transformed, the transformation is recorded by the object user data.  When the mesh is saved in a <em>.3dm</em> file, the object user data is saved too.</p>

<p>All object user data is saved in a class you write that is derived from the class <code>ON_UserData</code>.</p>

<h3 id="attaching-object-user-data-to-crhinoobjects">Attaching Object User Data to CRhinoObjects</h3>

<p>The Rhino geometry table is where the bulk of the Rhino model is stored.  This is where the points, curves, meshes, surface, polysurfaces, annotation, render lights, and so on are stored.  Each member of the geometry table is derived from the <code>CRhinoObject</code> class.  There are three places you can attach object user data to a <code>CRhinoObject</code>:</p>

<ol>
  <li>The <code>CRhinoObject</code> geometry class</li>
  <li>The <code>CRhinoObject</code> attributes class, and</li>
  <li>The <code>CRhinoObject</code> itself.</li>
</ol>

<p>Object user data attached to the geometry and attributes class persists through copys, transformations, and file IO.  Object user data attached directly on the <code>CRhinoObject</code> class is never saved in <em>.3dm</em> file.</p>

<p>To attach object user data to the <code>CRhinoObject</code> geometry use <code>CRhinoObject::AttachGeometryUserData()</code>.  This call attaches the user data to the <code>CRhinoObject.m_geometry</code> member.  This user data will persist when the object is copied, transformed, or saved in <em>.3dm</em> files.</p>

<p>To attach object user data to the <code>CRhinoObject</code> attributes, use <code>CRhinoObject::AttachAttributeUserData()</code>.  This call attaches the user data to the <code>CRhinoObject.m_attributes</code> member.  This user data will persist when the object is copied, transformed, or saved in <em>.3dm</em> files.</p>

<p>To attach object user data to the <code>CRhinoObject</code> itself, use <code>CRhinoObject::AttachUserData()</code>.  This user data is attached to the <code>CRhinoObject</code> class itself and will never be saved in <em>.3dm</em> files.  It is a good place to attach runtime information that applies only to the specific class it is attached to.  In general, object user data attached directly to a <code>CRhinoObject</code> class will have <code>m_userdata_copycount = 0</code> and will have an <code>Archive()</code> function that returns <code>false</code>.</p>

<h2 id="samples">Samples</h2>

<p>The first sample, <em>CMyUserData1</em>, shows how to make a simple piece of user data that is not saved in <em>.3dm</em> files.  The second sample, <em>CMyUserData2</em>, shows how to make a piece of user data that is saved in <em>.3dm</em> files.</p>

<p>You can download the source for the next two samples here: <a href="/files/myuserdataexample.zip"><span class="glyphicon glyphicon-download"></span></a> <a href="/files/myuserdataexample.zip">mcneelcodesigning.zip</a></p>

<h3 id="cmyuserdata1">CMyUserData1</h3>

<pre><code class="language-cpp">class CMyUserData1 : public ON_UserData
{
public:

  /*
  Returns:
   Uuid used to identify this type of user data.
   This is the value saved in m_userdata_uuid and
   passed to ON_Object::GetUserData().
  */
  static ON_UUID Id();

  CMyUserData1();
  ~CMyUserData1();

  //... download example for more details

  ON_wString m_my_string;
};
</code></pre>

<p>The <code>CMyUserData1</code> class must always be on the heap (constructed by calling the C/C++ new operator).  The class’s constructor must initialize two <code>ON_UserData</code> fields, <code>m_userdata_uuid</code>, <code>m_application_uuid</code>.  In addition, if you want the object user data copied whenever its parent object is copied, you have to set <code>m_userdata_copycount</code> to one…</p>

<pre><code class="language-cpp">ON_UUID CMyUserData1::Id()
{
  // Use Microsoft's guidgen to get a unique id.
  // {1129B130-B840-...}
  static const ON_UUID id = { 0x1129b130, 0xb840, ... };
  return id;
}

CMyUserData1::CMyUserData1()
{
  m_userdata_uuid = CMyUserData1::Id();
  m_application_uuid = MyPlugIn().PlugInID();
  m_userdata_copycount = 1;  enable copying
}

// ... download example for more details
</code></pre>

<p>Attaching object user data to a parent object is a simple matter…</p>

<pre><code class="language-cpp">ON_Mesh* pMesh = ...;
CMyUserData1* pMyUserData1 = new CMyUserData1();
pMyUserData1-&gt;m_my_string = L"How, now, brown cow?";
if ( pMesh-&gt;AttachUserData(pMyUserData1) )
{
  // It worked.  The mesh class will manage the user
  // data and delete it at the appropriate time.
  RhinoApp().Print("User data attached.\n"):
}
else
{
  // It didn't work.  This usually means that
  // the parent object already has this kind
  // of user data attached.
  RhinoApp().Print("User data not attached.\n");
  delete pMyUserData;
}
pMyUserData = 0;
</code></pre>

<p>The user data’s <em>UUID</em> is used to retrieve the user data from a parent object…</p>

<pre><code class="language-cpp">ON_Mesh* pMesh = ...;
ON_UserData1* pUserData = pMesh-&gt;GetUserData(CMyUserData1::Id());
CMyUserData1** pMyUserData1 = static_cast&lt;CMyUserData1**&gt;(pUserData);
if ( pMyUserData1 )
{
  RhinoApp().Print("Got user data.\n"):
}
else
{
  RhinoApp().Print("My user data is not on the mesh.\n"):
}
</code></pre>

<h3 id="cmyuserdata2">CMyUserData2</h3>

<p>Make sure you completely understand the <em>CMyUserData1</em> sample above before studying this sample.</p>

<p>To have your user data saved in files, you have to add several IO related functions and add full openNURBS object support to your class…</p>

<pre><code class="language-cpp">class CMyUserData2 : public ON_UserData
{
  // openNURBS classes that are saved in .3dm files require
  // an ON_OBJECT_DECLARE call in their declaration.
  ON_OBJECT_DECLARE(CMyUserData2);

public:

 static ON_UUID Id();

 CMyUserData2();
 ~CMyUserData2();

  // override virtual ON_UserData::Archive()
  BOOL Archive() const;

  // override virtual ON_UserData::Write()
  BOOL Write(ON_BinaryArchive&amp; binary_archive) const;

  // override virtual ON_UserData::Read()
  BOOL Read(ON_BinaryArchive&amp; binary_archive);

  // ... download example for more details

 ON_wString m_my_string;
 ON_3dPoint m_my_point;
};
</code></pre>

<p>Again, the <code>CMyUserData2</code> class must always be on the heap (constructed by calling the C/C++ new operator).  To support file IO, the definition of <code>CMyUserData2</code> must contain the <code>ON_OBJECT_DECLARE</code> macro.</p>

<p>The cpp file where the class is implemented must contain the <code>ON_OBJECT_IMPLEMENT</code> macro shown here:</p>

<pre><code class="language-cpp">ON_OBJECT_IMPLEMENT(CMyUserData2,ON_UserData,"0D8FA7AB-F8A4-...");
</code></pre>

<p>The construction code for <code>CMyUserData2</code> looks like:</p>

<pre><code class="language-cpp">ON_UUID CMyUserData2::Id()
{
  return CMyUserData2::m_CMyUserData2_class_id.Uuid();
}

CMyUserData2::CMyUserData2()
{
  m_userdata_uuid = CMyUserData2::Id();
  m_application_uuid = MyPlugIn().PlugInID();
  m_userdata_copycount = 1;  // enable copying

  // initialize your data members here
  m_my_point.Set(0.0,0.0,0.0);
}
</code></pre>

<p>The <code>CMyUserData2::Archive()</code>, <code>CMyUserData2::Read()</code>, <code>CMyUserData2::Write()</code> functions look something like this…</p>

<pre><code class="language-cpp">BOOL CMyUserData2::Archive() const
{
  // If false is returned, nothing will be saved in 3dm archives.
  return true;
}

BOOL CMyUserData2::Write(ON_BinaryArchive&amp; binary_archive) const
{
  // ... download example for more details about adding version support

  int minor_version = 0;
  bool rc = binary_archive.BeginWrite3dmChunk(
       TCODE_ANONYMOUS_CHUNK,
       1,
       minor_version
       );
  if (!rc)
    return false;

  // Write class members like this
  for (;;)
  {
    // version 1.0 fields
    rc = binary_archive.WriteString(m_my_string);
    if (!rc) break;

    rc = binary_archive.WritePoint(m_my_point);
    if (!rc) break;

    break;
  }

  if ( !binary_archive.EndWrite3dmChunk() )
   rc = false;

  return rc;
}

BOOL CMyUserData2::Read(ON_BinaryArchive&amp; binary_archive)
{
  // ... download example for more details about adding version support

  int major_version = 0;
  int minor_version = 0;
  bool rc = binary_archive.BeginRead3dmChunk(
         TCODE_ANONYMOUS_CHUNK,
         &amp;major_version,
         &amp;minor_version
         );
  if (!rc)
    return false;

  // Read class members like this
  for (;;)
  {
    rc == ( 1 == major_version );
    if (!rc) break;

    // version 1.0 fields
    rc = binary_archive.ReadString(m_my_string);
    if (!rc) break;

    rc = binary_archive.ReadPoint(m_my_point);
    if (!rc) break;

    break;
  }

  // If BeginRead3dmChunk() returns true,
  // then EndRead3dmChunk() must be called,
  // even if a read operation failed.
  if ( !binary_archive.EndRead3dmChunk() )
    rc = false;

 return rc;
}
</code></pre>

<h2 id="user-data-operator-and-copy-construction">User Data operator= and Copy Construction</h2>

<p>In general, you do not need to explicitly override the default copy constructor and <code>operator=</code> that C/C++ generates for you.  Incorrectly implemented copy constructors and <code>operator=</code>s are a common source of bugs.  The C/C++ defaults will work perfectly if every member of your class is a built-in data type (<code>int</code>, <code>double</code>, …) or a class that properly handles copy construction and <code>operator=</code> (<code>ON_NurbsCurve</code>, <code>ON_3dPoint</code>, <code>ON_Simple</code>/<code>ClassArray&lt;&gt;</code>, …).</p>

<p>The main reason you have to explicitly implement a copy constructor and <code>operator=</code> is to handle fields that involve explicit heap allocation and deallocation.  In the sample below, the field <code>m_i_array</code> is an array of integers that is on the heap.</p>

<pre><code class="language-cpp">class CMyUserData3 : public ON_UserData
{
  ON_OBJECT_DECLARE(CMyUserData3);
public:
  static ON_UUID Id();
  static ON_UUID ApplicationId();
  static CMyUserData3** Get(const ON_Object**);

  CMyUserData3();
  ~CMyUserData3();
  CMyUserData3(const CMyUserData3&amp; src);
  CMyUserData3&amp; operator=(const CMyUserData3&amp; src);

  //...

  int m_i_count;
  int* m_i_array;
};

ON_OBJECT_IMPLEMENT(CMyUserData3,
                    ON_UserData,
                    &lt;&lt;guidgen generated uuid here&gt;&gt;
                    );

ON_UUID CMyUserData3::Id()
{
  return CMyUserData3::m_CMyUserData3_class_id.Uuid();
}

ON_UUID CMyUserData3::ApplicationId()
{
  return &lt;&lt;your plugin name&gt;&gt;().PlugInID();
}

CMyUserData3** CMyUserData3::Get(const ON_Object** object)
{
  return CMyUserData3::Cast( (object != 0)
                             ? object-&gt;GetUserData( CMyUserData3::Id() )
                          );
}

CMyUserData3::CMyUserData3()
{
  m_userdata_uuid = CMyUserData3::Id();
  m_application_uuid = CMyUserData3::ApplicationId();
  m_userdata_copycount = 1;

  // Initialize your class's fields
  m_i_count = 0;
  m_i_array = 0;
}

CMyUserData3::~CMyUserData3()
{
  // virtual function
  if ( 0 != m_i_array )
    onfree(m_i_array);
}
</code></pre>

<p>When the copy constructor is called, the memory for “this” is not initialized.  You must call the base class copy constructor, initialize all your class’s fields, and then copy your class’s fields…</p>

<pre><code class="language-cpp">CMyUserData3::CMyUserData3(const CMyUserData3&amp; src )
{
  m_userdata_uuid = CMyUserData3::Id();
  m_application_uuid = CMyUserData3::ApplicationId();
  m_transform_count = 0;

  // DO NOT SET OTHER ON_UserData fields
  // In particular, do not set m_userdata_copycount

  Copy you class's fields
  m_i_count = 0;
  m_i_array = 0;
  if( src.m_i_count &gt; 0 &amp;&amp; src.m_i_array != 0 )
  {
    m_i_array = (int**)onmalloc(src.m_i_count**sizeof(m_i_array[0]));
    if ( m_i_array != 0 )
    {
      memcpy( m_i_array,
              src.m_i_array,
              src.m_i_count*sizeof(m_i_array[0])
           );
      m_i_count = src.m_i_count;
    }
  }
}
</code></pre>

<p>When <code>operator=</code> is called, “this” has already been constructed and may already have been used.  You must destroy any existing information, call the the base class <code>operator=</code>, and then copy your class’s fields…</p>

<pre><code class="language-cpp">CMyUserData3&amp; CMyUserData3::operator=(const CMyUserData3&amp; src)
{
  if ( this != &amp;src )
  {
   // Destroy your class's existing information
   // (Otherwise you will leak memory if "this"
   // has been used before.)
   m_i_count = 0;
   if ( m_i_array != 0 )
   {
     onfree(m_i_array);
     m_i_array = 0
   }

   // Use the base class operator=() to correctly
   // copy all ON_UserData fields.
   ON_UserData::operator=(src);

   // Copy your class's fields
   if( src.m_i_count &gt; 0 &amp;&amp; src.m_i_array != 0 )
   {
     m_i_array = (int**)onmalloc(src.m_i_count**sizeof(m_i_array[0]));
     if ( m_i_array != 0 )
     {
       memcpy( m_i_array,
               src.m_i_array,
               src.m_i_count*sizeof(m_i_array[0])
             );
       m_i_count = src.m_i_count;
     }
   }
  }
  return *this;
}
</code></pre>

<h2 id="sharing-user-data-between-plugins">Sharing User Data Between Plugins</h2>

<p>The best way to share user data between plugins is to have access to the plugins data controlled by a shared <em>DLL</em> - a <em>DLL</em> that is used by all interested plugins.  The user data class definitions and declarations, along with any helper functions used to access this data, are then added to and exported from this <em>DLL</em>.</p>

<p>The easiest way to make <em>DLLs</em> for Rhino plugins is to simply run the <em>Rhino Plugin Wizard</em> from Visual Studio.  When the wizard finishes, simply delete the plugins object (<em>cpp</em> and <em>h</em> files) and the command file.  Then change the output file extension from <em>rhp</em> to <em>dll</em>.  Now, you have a <em>MFC DLL</em> that links with the Rhino C/C++ SDK.</p>

<p>One important piece of information to keep in mind is that when you create a class derived from <code>ON_UserData</code> and you expect this data to be serialized in a <em>3dm</em> file, then you must assign the owning plugins’s <em>UUID</em> to the <code>ON_UserData::m_application_uuid</code> data member.  This is how Rhino knows what plugins to load when it encounters plugin user data when reading a <em>3dm</em> file.  Note, it is not important what plugins’s <em>UUID</em> is assigned to the user data because all of the plugins are going to dynamically load the <em>DLL</em> when they are loaded anyway.  But, some plugin must be “in charge.”</p>

<p>For example:</p>

<pre><code class="language-cpp">ON_UUID CPlugInUserData::PlugInId()
{
  // Copied from PlugIn1PlugIn.cpp

  // {F8B054CD-19A3-4D46-AB7E-DB3E8EF8CF5B}
  static const GUID PlugIn1PlugIn_UUID =
  { 0xF8B054CD, 0x19A3, 0x4D46, { 0xAB, 0x7E, 0xDB, 0x3E, 0x8E, 0xF8, 0xCF, 0x5B } };
  return PlugIn1PlugIn_UUID;
}

CPlugInUserData::CPlugInUserData()
{
  m_userdata_uuid = CPlugInUserData::Id();

  /*
  CRITICAL:
    m_application_uuid must be assigned the uuid of the plugin
    that will be responsible for reading and writing our user data.
    In this example, we'll use PlugIn1 as our primary plugin.
  */
  m_application_uuid = CPlugInUserData::PlugInId();

  m_userdata_copycount = 1; // enable copying

  // initialize your data members here
  m_point.Set( 0.0, 0.0, 0.0 );
  m_string = L;
}
</code></pre>

<p>This plugin sample contains two plugin projects and one <em>DLL</em> project:</p>

<p><a href="/files/testshareduserdata.zip"><span class="glyphicon glyphicon-download"></span></a> <a href="/files/testshareduserdata.zip">testshareduserdata.zip</a></p>

<p>To load the sample, just download and extract into some folder, and then open <em>Test.sln</em> is Visual Studio.</p>

<h2 id="related-topics">Related Topics</h2>

<ul>
  <li><a href="/samples/cpp/attaching-user-data-to-brep-components">Attaching User Data to Brep Components</a></li>
</ul>

        </article>

      <!--</div>-->

    </div>
</div>
</div>

        <!--/div-->
      </div>

      <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">

      
        <div class="row">
          <div class="col-md-4">

            <p class="text">
              
                Author: <a href="https://discourse.mcneel.com/users/dale/activity">Dale Fugier</a>
              
            </p>
          </div>
          <div class="col-md-4 text-center">
            <span class="icon  icon--github">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <a href="https://github.com/mcneel/developer-rhino3d-com/blob/6/_guide_topics/cpp/user-data.md" target="_blank">Edit page on GitHub</a>
          </div>
            <div class="col-md-4">
              <span class="pull-right">
                <span class="glyphicon glyphicon-cog"></span>&nbsp;<a href="/admin">Admin</a>
              </span>
            </div>
        </div>

        <div class="row text-center">
          © 1997 - 2018 Robert McNeel &amp; Associates
        </div>

      

    </div>

  </div>

  <script>
    if (navigator.appVersion.indexOf("Win")!=-1)
    {
      var body = document.getElementsByTagName("body");
      body[0].style.fontWeight = '400';
    }
  </script>

</footer>

    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!-- MathJax -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script type="text/javascript">
    $('body').scrollspy({
        target: '.bs-docs-sidebar',
        offset: 150 /* fixed header is about 40px high */
    });
    </script>
    <!--
    Next block expands Bootstrap Collapse component when linked to it.  Used in rhinoscriptsyntax api docs
    ex: http://developer.rhino3d.com/api/RhinoScriptSyntax/win/#collapse-PointCompare
    -->
    <script type="text/javascript">
    $(document).ready(function () {
        if(document.title == 'rhinoscriptsyntax' && location.hash != null && location.hash != ""){
            $('.collapse').removeClass('in');
            $('#collapse-' + location.hash.split("-")[1] + '.collapse').collapse('show');
        }
    });
    $('#accordion').on('shown.bs.collapse', function (e) {
       var t = e.target
       if (t == null) return;
       var id = t.getAttribute('aria-labelledby');
       $('html, body').animate({
           scrollTop: $("#" + id).offset().top
       }, 0);
    })
    </script>
  </body>

</html>
