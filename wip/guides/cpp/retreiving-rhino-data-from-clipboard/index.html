<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Retrieving Rhino Data from the Clipboard with C/C++</title>
  <meta name="description" content="This guide demonstrates how to access Rhino data from the Windows Clipboard using C/C++.  Using C/C++">

  <!-- OpenGraph for Facebook, Twitter, Slack unfurling -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/guides/cpp/retreiving-rhino-data-from-clipboard/" />
  <meta property="og:title" content="Retrieving Rhino Data from the Clipboard" />
  <meta property="og:description" content="This guide demonstrates how to access Rhino data from the Windows Clipboard using C/C++." />
  <meta property=”og:site_name” content="developer.rhino3d.com"/>
  <meta property=”og:image” content="/wip/images/rhinodev_logo_unfurl.png"/>

  <!-- twitter card tags additive with the og: tags -->
  <meta name="twitter:domain" value="developer.rhino3d.com" />
  <meta name="twitter:title" value="Retrieving Rhino Data from the Clipboard" />
  <meta name="twitter:description" value="This guide demonstrates how to access Rhino data from the Windows Clipboard using C/C++." />
  
    
      <meta name="twitter:image" content="/wip/images/rhinodev_logo_unfurl.png" />
    
  
  <meta name="twitter:url" value="http://developer.rhino3d.com" />
  
  <meta name="twitter:label1" value="Platform(s)" />
  <meta name="twitter:data1" value="Windows" />
  
  
  <meta name="twitter:label2" value="Language(s)" />
  <meta name="twitter:data2" value="C/C++" />
  

  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/github.min.css">
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/languages/vbnet.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <!-- Overridden theme -->
  <link rel="stylesheet" href="/wip/css/main.css">

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
  <!-- Bootstrap override -->
  <link rel="stylesheet" href="/wip/css/bootstrap-override.css">

  <link rel="canonical" href="http://developer.rhino3d.com/wip/guides/cpp/retreiving-rhino-data-from-clipboard/">
  <link rel="alternate" type="application/rss+xml" title="Rhino Developer Docs" href="http://developer.rhino3d.com/wip/feed.xml" />

  <link rel="shortcut icon" href="http://developer.rhino3d.com/favicon.ico?v=2" />
  <!-- Saving bookmarks to mobile devices -->
  <!-- For non-Retina (@1× display) iPhone, iPod Touch, and Android 2.1+ devices: -->
  <link rel="apple-touch-icon-precomposed" href="/wip/images/apple-touch-icon-precomposed.png"><!-- 57×57px -->
  <!-- For the iPad mini and the first- and second-generation iPad (@1× display) on iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/wip/images/apple-touch-icon-72x72-precomposed.png">
  <!-- For the iPad mini and the first- and second-generation iPad (@1× display) on iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/wip/images/apple-touch-icon-76x76-precomposed.png">
  <!-- For iPhone with @2× display running iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/wip/images/apple-touch-icon-114x114-precomposed.png">
  <!-- For iPhone with @2× display running iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/wip/images/apple-touch-icon-120x120-precomposed.png">
  <!-- For iPad with @2× display running iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/wip/images/apple-touch-icon-144x144-precomposed.png">
  <!-- For iPad with @2× display running iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/wip/images/apple-touch-icon-152x152-precomposed.png">
  <!-- For iPhone 6 Plus with @3× display: -->
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/wip/images/apple-touch-icon-180x180-precomposed.png">
  <!-- For Chrome for Android: -->
  <link rel="icon" sizes="192x192" href="images/touch-icon-192x192.png">

  <!-- Diable crawling until this version is the stable version -->
  <meta name="robots" content="noindex" />
</head>


  <body>

    <!-- Google Tag Manager **This belongs right after the <body> tag**-->
    <noscript>
        <iframe src="//www.googletagmanager.com/ns.html?id=GTM-MWMDKN"
        height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <script>
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MWMDKN');
    </script>
    <!-- End Google Tag Manager -->


    
<div class="version-banner">
    Hey, you're viewing the <strong>wip</strong> version of this page!
    <a href="/guides/cpp/retreiving-rhino-data-from-clipboard/">View the current version instead.</a>
</div>

<!-- Check the version banner for broken links and remove the link if found -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>
$(document).ready(function()
{
  var splitPath = window.location.pathname.split("/");
  var nonWipURL = "/" + splitPath.splice(2,splitPath.length-2).join("/");

  $.get(nonWipURL).fail(function ()
  {
    var $aTag = $("div.version-banner > a");
    $aTag.text("View the current site instead.");
    $aTag.attr("href", "/");
  });
});
</script>




    <div class="container">

      <header class="site-header">


    <a class="site-title" href="/wip/"><img src="/wip/images/rhinodevlogo148x128.png" alt="Rhino Developer Docs" height="48" width="56"></a><a class="site-title" href="/wip/">Rhino Developer Docs</a>

    <nav class="site-nav">
      <img class="menu-icon" src="/wip/images/gi.svg">
      
      <div class="trigger">
      	<!--<a class="page-link" href="/wip/">Welcome</a>-->
        <!-- get current page title and "collection" to figure out which nav
             link should be "active" -->
        
        
        
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
        
          
            
              
                
                  <a class="page-link active" href="/wip/guides/">Guides</a>
                
              
            
          
        
          
            
              
                
                  <a class="page-link" href="/wip/api/">API</a>
                
              
            
          
        
          
            
              
                
                  <a class="page-link" href="/wip/samples/">Samples</a>
                
              
            
          
        
          
            
          
        
          
            
              
                
                  <a class="page-link" href="/wip/videos/">Videos</a>
                
              
            
          
        
        <a class="page-link" href="http://discourse.mcneel.com/c/rhino-developer">Forums</a>
        <!-- Google Search Engine -->
        <!-- TODO Move to this site back into the Mcneel search, or use a simple site only search for results -->
        <div id="sitesearch">
            <!-- Google CSE Search Box Begins  -->
            <!-- Use of this code assumes agreement with the Google Custom Search Terms of Service. -->
            <!-- The terms of service are available at https://www.google.com/cse/docs/tos.html -->
            <form id="cref" action="/wip/search-results.html">
                <input type="hidden" name="cref" value="007988927381198593803:mcq6pshqsn8" />
                <input id="searchtext" type="text" name="q" size="24" value="" placeholder="search" />
                <input class="searchBox" type="submit" name="sa" size="2" value=" " />
            </form>
        <!-- Google CSE Search Box Ends -->
        </div>
        <!--End of Google Search Engine -->
      </div>
    </nav>

</header>


      <div class="page-content">
        <!--div class="wrapper"-->
          <div class="container-fluid">

<div class="row-fluid">
    <!--Nav Bar -->
    <nav class="col-xs-0 col-md-3 bs-docs-sidebar">
    <ul id="sidebar" class="nav nav-stacked fixed">
        <!-- Find the h2 group and any h3 subgroups -->
        

        
          

          
            
            
            
            
            <li>
              <a href="#overview">Overview</a>

              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#sample">Sample</a>

              

            </li>
          

        
    </ul>
</nav>


    <!--Main Content -->
    <div class="col-xs-12 col-md-9">
      <!--<div class="post">-->

        <article class="post-content">
          <ol class="breadcrumb">
              
              
              
              <li><a href="/wip/guides/cpp">C/C++</a></li>
              
              <li class="active">Advanced</li>
              
          </ol>

          <h1>Retrieving Rhino Data from the Clipboard</h1>

          <p><span class="guide_byline">by <a href="https://discourse.mcneel.com/users/dale/activity">Dale Fugier</a></span>
</p>

          <p>This guide demonstrates how to access Rhino data from the Windows Clipboard using C/C++.</p>

          <h2 id="overview">Overview</h2>

<p>Like most Windows applications, Rhino can cut, copy, and paste information to and from the Windows Clipboard.  When Rhino either cuts or copies geometry to the clipboard, it creates a temporary 3DM file that contains the selected geometry.  Rhino then stores the temporary filename in the Clipboard.  When a paste operation is invoked, Rhino determines if the Clipboard contains the name of a temporary Rhino file.  If found, Rhino simply imports the temporary file.</p>

<p>Rhino registers custom Clipboard formats to store the temporary file names: a unique Clipboard format for each Rhino version.</p>

<h2 id="sample">Sample</h2>

<p>The following sample demonstrates how to determine of there is Rhino information in the Windows Clipboard.  If there is Rhino data in the Clipboard, the sample will retrieve the name of the temporary file.  Once this file name is known, you can whatever means necessary to retrieve the data.  For example, if you are using this code from a Rhino plugin, you could script the running of Rhino’s <em>Paste</em> command to insert the geometry into the current document.  If you are in a standalone application, you would use the openNURBS toolkit to read the temporary .3DM file.</p>

<pre><code class="language-cpp">/////////////////////////////////////////////////////////////////////////////
// clipboard.cpp

#include "StdAfx.h"
#include &lt;afxole.h&gt; // MFC OLE clipboard support

// TODO: Fill this in with your own message printing
static void myPrintMessage( LPCTSTR lpMessage )
{
  if( 0 == lpMessage || 0 == lpMessage[0] )
    return;
#ifdef RHINO_SDK_CLASS
  RhinoApp().Print( ON_wString(lpMessage) );
#else
  MessageBox( 0, lpMessage, _T("Clipboard Message"), MB_SYSTEMMODAL|MB_OK|MB_ICONINFORMATION);
#endif
}

// TODO: Return your application main window handle
static HWND myMainWnd()
{
#ifdef RHINO_SDK_CLASS
  return RhinoApp().MainWnd();
#else
  return AfxGetMainWnd()-&gt;m_hWnd;
#endif
}

static UINT myGetClipboardFormat( int ver = 4 )
{
  UINT v = 0;

  if( 1 == ver )      // Rhino 1.0
  {
    static UINT v1 = 0;
    if( v1 &lt; 1 )
      v1 = RegisterClipboardFormat( _T("Rhino 1.0 3DM Clip") );
    v = v1;
  }
  else if( 2 == ver ) // Rhino 2.0
  {
    static UINT v2 = 0;
    if( v2 &lt; 1 )
      v2 = RegisterClipboardFormat( _T("Rhino 2.0 3DM Clip") );
    v = v2;
  }
  else if( 3 == ver ) // Rhino 3.0
  {
    static UINT v3 = 0;
    if( v3 &lt; 1 )
      v3 = RegisterClipboardFormat( _T("Rhino 3.0 3DM Clip") );
    v = v3;
  }
  else if( 4 == ver ) // Rhino 4.0
  {
    static UINT v4 = 0;
    if( v4 &lt; 1 )
      v4 = RegisterClipboardFormat( _T("Rhino 4.0 3DM Clip global mem") );
    v = v4;
  }

  return v;
}

static BOOL myGetTempFileName( CString&amp; strResult )
{
  CString strPath, strFileName;

  int rc = GetTempPath( _MAX_PATH, strPath.GetBuffer(_MAX_PATH) );
  strPath.ReleaseBuffer();

  if( rc == 0 )
    return false;

  rc = GetTempFileName( strPath, _T("rh$"), 0, strFileName.GetBuffer(_MAX_PATH) );
  strFileName.ReleaseBuffer();

  if( rc == 0 )
    return false;

  strResult = strFileName;
  return true;
}

static BOOL CopyClipboardToTempFile( CString&amp; strTempFileName, UINT clipboard_format )
{
  if( !IsClipboardFormatAvailable(clipboard_format) )
  {
    myPrintMessage( _T("CopyClipboardV2ToTempFile() - Rhino clipboard format is not available.\n") );
    return false;
  }

  CString strFileName;
  if( !myGetTempFileName(strFileName) )
  {
    myPrintMessage( _T("CopyClipboardV2ToTempFile() - Unable to calculate temporary file name.\n" ));
    return false;
  }

  if( !OpenClipboard(myMainWnd()) )
  {
    myPrintMessage( _T("CopyClipboardV2ToTempFile() - Unable to open clipboard.\n") );
    return false;
  }

  HANDLE hMem = GetClipboardData( clipboard_format );
  if( 0 == hMem )
  {
    myPrintMessage( _T("CopyClipboardV2ToTempFile() - Unable to get clipboard data.\n") );
    CloseClipboard();
    return false;
  }

  DWORD* ptr = (ULONG*)GlobalLock( hMem );
  if( 0 == ptr )
  {
    myPrintMessage( _T("CopyClipboardV2ToTempFile() - Unable to lock global memory block.\n") );
    CloseClipboard();
    return false;
  }

  // size is encoded in the first dword
  int size = (int)ptr[0];
  if( size &lt;= 0)
  {
    myPrintMessage( _T("CopyClipboardV2ToTempFile() - Unable to determine size of clipboard memory block.\n") );
    GlobalUnlock( hMem );
    CloseClipboard();
    return false;
  }

  FILE* fp = _tfopen( strFileName, _T("wb") );

#define CopyClipboardV2ToTempFile_BAIL( msg )\
{\
  GlobalUnlock( hMem );\
  CloseClipboard();\
  if( fp )\
  {\
    fclose( fp );\
    ::DeleteFile( strFileName );\
  }\
  CloseClipboard();\
  myPrintMessage( msg );\
}

  if( 0 == fp )
    CopyClipboardV2ToTempFile_BAIL( _T("CopyClipboardV2ToTempFile() - Unable to open temporary file.\n") );

  if( fwrite(&amp;ptr[1], size, 1, fp) != 1 )
    CopyClipboardV2ToTempFile_BAIL( _T("CopyClipboardV2ToTempFile() - Unable to write information to temporary file.\n") );

  if( ferror(fp) )
    CopyClipboardV2ToTempFile_BAIL( _T("CopyClipboardV2ToTempFile() - Error in temporary file stream.\n") );

  if( fflush(fp) )
    CopyClipboardV2ToTempFile_BAIL( _T("CopyClipboardV2ToTempFile() - Error in flushing temporary file buffers.\n"));

  if( fclose(fp) )
    CopyClipboardV2ToTempFile_BAIL( _T("CopyClipboardV2ToTempFile() - Error in closing temporary file.\n") );

  GlobalUnlock( hMem );

  if( 0 == CloseClipboard() )
  {
    DeleteFile( strFileName );
    myPrintMessage( _T("CopyClipboardV2ToTempFile() - Unable to close the clipboard.\n") );
    return false;
  }

  strTempFileName = strFileName;
  return true;
}

static BOOL ReadFileNameFromClipboard( const wchar_t* lpFileName, CString&amp; strOutputFile )
{
  CString strFileName( lpFileName );
  strFileName.TrimLeft();
  strFileName.TrimRight();
  if( strFileName.IsEmpty() )
    return false;

  if( !myGetTempFileName(strOutputFile) )
    return false;

  return CopyFile( strFileName, strOutputFile, false );
}

static BOOL GetFileFromClipboard( CString&amp; strFileName, int&amp; file_version )
{
  FORMATETC fe = { 0, 0, DVASPECT_CONTENT, -1, TYMED_FILE };
  STGMEDIUM stgm;

  COleDataObject odo;
  odo.AttachClipboard();

  // V4 file in clipboard
  UINT v4_cbformat = myGetClipboardFormat( 4 );
  fe.cfFormat = v4_cbformat;
  if( odo.GetData(v4_cbformat, &amp;stgm, &amp;fe) &amp;&amp; stgm.tymed == TYMED_FILE )
  {
    file_version = 4;
    return ReadFileNameFromClipboard( stgm.lpszFileName, strFileName );
  }

  // V3 file in clipboard
  UINT v3_cbformat = myGetClipboardFormat( 3 );
  fe.cfFormat = v3_cbformat;
  if( odo.GetData(v3_cbformat, &amp;stgm, &amp;fe) &amp;&amp; stgm.tymed == TYMED_FILE )
  {
    file_version = 3;
    return ReadFileNameFromClipboard( stgm.lpszFileName, strFileName );
  }

  // V1 or V2 file in clipboard
  UINT v1_cbformat = myGetClipboardFormat( 1 );
  UINT v2_cbformat = myGetClipboardFormat( 2 );
  UINT clipboard_format = 0;
  if( ::IsClipboardFormatAvailable(v2_cbformat) )
  {
    file_version = 2;
    clipboard_format = v2_cbformat;
  }
  else if( ::IsClipboardFormatAvailable(v1_cbformat) )
  {
    file_version = 1;
    clipboard_format = v1_cbformat;
  }

  if( clipboard_format &gt; 0 )
    return CopyClipboardToTempFile( strFileName, clipboard_format );

  return false;
}
</code></pre>

        </article>

      <!--</div>-->

    </div>
</div>
</div>

        <!--/div-->
      </div>

      <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">

      
        <div class="row">
          <div class="col-md-4">

            <p class="text">
              
                Author: <a href="https://discourse.mcneel.com/users/dale/activity">Dale Fugier</a>
              
            </p>
          </div>
          <div class="col-md-4 text-center">
            <span class="icon  icon--github">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <a href="https://github.com/mcneel/developer-rhino3d-com/blob/wip/_guide_topics/cpp/retreiving-rhino-data-from-clipboard.md" target="_blank">Edit page on GitHub</a>
          </div>
            <div class="col-md-4">
              <span class="pull-right">
                <span class="glyphicon glyphicon-cog"></span>&nbsp;<a href="/wip/admin">Admin</a>
              </span>
            </div>
        </div>

        <div class="row text-center">
          © 1997 - 2016 Robert McNeel &amp; Associates
        </div>

      

    </div>

  </div>

  <script>
    if (navigator.appVersion.indexOf("Win")!=-1)
    {
      var body = document.getElementsByTagName("body");
      body[0].style.fontWeight = '400';
    }
  </script>

</footer>

    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <!-- MathJax -->
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script type="text/javascript">
    $('body').scrollspy({
        target: '.bs-docs-sidebar',
        offset: 150 /* fixed header is about 40px high */
    });
    </script>
  </body>

</html>
